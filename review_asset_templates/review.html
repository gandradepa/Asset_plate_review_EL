<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Asset Review - Electrical</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#fafafa}
    .shell{background:#fff;border:1px solid #e9ecef;border-radius:.6rem}
    .header{border-bottom:1px solid #e9ecef;background:#fff;border-radius:.6rem .6rem 0 0}
    .header .meta small{color:#6c757d}
    .viewer{display:grid;grid-template-columns:minmax(520px,1fr) 480px;gap:1rem}
    .image-box{background:#fff;border:1px solid #e9ecef;border-radius:.5rem;padding:.5rem;display:flex;align-items:center;justify-content:center;min-height:520px}
    .image-box img{max-width:100%;max-height:76vh;transition:transform .15s ease}
    .thumbs{display:flex;gap:.75rem;margin-top:.75rem}
    .thumb{width:120px;border:1px solid #e9ecef;border-radius:.5rem;overflow:hidden;background:#fff;cursor:pointer}
    .thumb.active{outline:2px solid #0d6efd}
    .thumb .label{
      font-size:.68rem;     /* reduced size to fit text */
      line-height:1.2;
      padding:.25rem .3rem;
      color:#6c757d;
      border-bottom:1px solid #eef1f4;
      background:#fafafa;
      white-space:nowrap;
      overflow:hidden;
    }
    .thumb .missing{height:84px;display:flex;align-items:center;justify-content:center;background:#fde2e1;color:#a10000}
    .thumb img{width:100%;height:84px;object-fit:cover;display:block}
    .form-card{background:#fff;border:1px solid #e9ecef;border-radius:.5rem;padding:1rem}
    .field-grid{display:grid;grid-template-columns:1fr;gap:.75rem}
    .desc-hint{font-size:.75rem;color:#cc3366}
    @media (max-width:1100px){.viewer{grid-template-columns:1fr}}
    .hidden { display: none !important; }
  </style>
</head>
<body class="container-fluid py-3">

  <div class="shell mx-auto" style="max-width:1600px">
    <!-- Header -->
    <div class="header p-2 px-3 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='ubc-logo.png') }}" alt="UBC" style="height:38px"></a>
        <div class="meta">
          <div class="fw-semibold">Asset Review - Electrical</div>
          <small>
            <strong>QR:</strong> {{ qr_code }} &nbsp;&nbsp;
            <strong>Building:</strong> {{ building }} &nbsp;&nbsp;
            <strong>Type:</strong> {{ (asset_type or '') | upper | replace('-', '') | trim }} &nbsp;&nbsp;
            <strong>Doc:</strong> {{ doc_id }}
          </small>
        </div>
      </div>
      <a id="backTop" class="btn btn-outline-secondary btn-sm" href="{{ url_for('index') }}">Back to Dashboard</a>
    </div>

    <form method="POST" action="{{ url_for('save_review', doc_id=doc_id) }}" class="p-3">
      <input type="hidden" name="dashboard_query" id="dashboard_query" value="">
      <input type="hidden" name="Branch Panel" value="{{ data.get('Branch Panel','') }}">

      <div class="viewer">
        <!-- Left: image + controls + thumbs -->
        <div>
          <div class="image-box">
            {% set default_tag = '-0' if images.get('-0') and images['-0'].exists else (('-1' if images.get('-1') and images['-1'].exists else ('-2' if images.get('-2') and images['-2'].exists else None))) %}
            {% set default_url = images[default_tag].url if default_tag else None %} 
            <img id="mainImage" src="{{ default_url if default_url else '' }}" alt="Main">
          </div>

          <div class="d-flex align-items-center justify-content-between mt-2">
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-primary btn-sm" id="zoomIn">+ Zoom</button>
              <button type="button" class="btn btn-outline-primary btn-sm" id="zoomOut">- Zoom</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="rotate">Rotate</button>
            </div>
            <div class="d-flex gap-2">
              <a id="backUnderPic" href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">Back</a>
              <button type="submit" class="btn btn-outline-warning btn-sm" name="action" value="save_next">Skip</button>
            </div>
          </div>

          <div class="thumbs">
            {% for tag,label in {'-0':'Asset Plate (Optional)','-1':'UBC Asset Tag','-2':'Panel Schedule'}.items() %}
              {% set im = images.get(tag) %}
              <div class="thumb {% if default_tag == tag %}active{% endif %}" data-url="{{ im.url if im and im.exists else '' }}">
                <div class="label">{{ label }}</div>
                {% if im and im.exists %}
                  <img src="{{ im.url }}" alt="{{ label }}">
                {% else %}
                  <div class="missing">Missing</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Right: form -->
        <div class="form-card">
          <div class="field-grid">

            <div>
              <label class="form-label">Asset Group</label>
              <select class="form-select" name="Asset Group">
                {% for opt in asset_group_options %}
                  <option value="{{ opt }}" {% if (data.get('Asset Group') or 'Panels') == opt %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label class="form-label">Attribute</label>
              <input type="text" class="form-control" name="Attribute" value="{{ data.get('Attribute','') }}" readonly>
            </div>

            <div>
              <label class="form-label">UBC Asset Tag</label>
              <input type="text" class="form-control" name="UBC Asset Tag" value="{{ data.get('UBC Asset Tag','') }}">
            </div>

            <div>
              <label class="form-label">Ampere</label>
              <input type="text" class="form-control" name="Ampere" value="{{ data.get('Ampere','') }}">
            </div>

            <div>
              <label class="form-label">Supply From</label>
              <input type="text" class="form-control" name="Supply From" value="{{ data.get('Supply From','') }}">
            </div>

            <div>
              <label class="form-label">Volts</label>
              <input type="text" class="form-control" name="Volts" value="{{ data.get('Volts','') }}">
            </div>

            <div>
              <label class="form-label">Location</label>
              <input type="text" class="form-control" name="Location" value="{{ data.get('Location','') }}">
            </div>

            <div>
              <label class="form-label">Description (auto)</label>
              <input id="descField" type="text" class="form-control" value="{{ data.get('Description','') }}" readonly>
              <div class="desc-hint">Generated automatically from <b>UBC Asset Tag</b> (or Branch Panel, if present in JSON).</div>
            </div>

            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="Flagged" id="flagged" {% if data.get('Flagged') == 'true' %}checked{% endif %}>
              <label class="form-check-label" for="flagged">Flag for Review</label>
            </div>

            <div class="d-flex gap-2 mt-2">
              <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">Back</a>
              <button type="submit" class="btn btn-primary btn-sm" name="action" value="save">Save</button>
              <button type="submit" class="btn btn-outline-dark btn-sm" name="action" value="save_prev">⏮ Save & Prev</button>
              <button type="submit" class="btn btn-primary btn-sm" name="action" value="save_next">Save & Next ⏭</button>
            </div>

          </div>
        </div>
      </div>
    </form>
  </div>

  <footer class="text-center mt-3 pt-3 text-muted small">
    &copy; 2025 University of British Columbia - Maintenance Planning Department. All rights reserved.
  </footer>

  <script>
    (function(){
      const img = document.getElementById('mainImage');
      let scale=1, rot=0;
      const apply = ()=> img && (img.style.transform = `scale(${scale}) rotate(${rot}deg)`);
      document.getElementById('zoomIn').onclick  = ()=>{ scale=Math.min(scale+0.1,3.5); apply(); };
      document.getElementById('zoomOut').onclick = ()=>{ scale=Math.max(scale-0.1,0.3); apply(); };
      document.getElementById('rotate').onclick  = ()=>{ rot=(rot+90)%360; apply(); };

      document.querySelectorAll('.thumb').forEach(t=>{
        t.addEventListener('click',()=>{
          const url=t.getAttribute('data-url');
          if(!url) return;
          document.querySelectorAll('.thumb').forEach(x=>x.classList.remove('active'));
          t.classList.add('active');
          if(img){ img.src=url; scale=1; rot=0; apply(); }
        });
      });

      try{
        const q=localStorage.getItem('dashboardQuery')||'';
        ['backTop','backUnderPic'].forEach(id=>{
          const a=document.getElementById(id); if(a && q && q!=='?') a.href = a.href + q;
        });
        const hidden=document.getElementById('dashboard_query'); if(hidden) hidden.value=q||'';
      }catch(e){}

      const desc = document.getElementById('descField');
      function recompute(){
        const ubc=(document.querySelector('input[name="UBC Asset Tag"]')?.value||'').trim();
        const branch=(document.querySelector('input[name="Branch Panel"]')?.value||'').trim();
        const tag = ubc || branch;
        if(desc) desc.value = tag ? `Panel - ${tag}` : 'Panel';
      }
      ['UBC Asset Tag','Branch Panel'].forEach(n=>{
        const el=document.querySelector(`input[name="${n}"]`);
        if(el){ el.addEventListener('input',recompute); el.addEventListener('change',recompute); }
      });
    })();
  </script>
</body>
</html>
